# نظام الإشعارات المحدث

تم تحديث نظام الإشعارات بحيث يتعامل مع الإشعارات بطريقة ذكية حسب حالة الموقع.

## كيف يعمل النظام الجديد

### 1. عندما يكون الموقع مفتوح ومرئي
- تظهر الإشعارات كـ **Toast** داخل الموقع فقط
- لا تظهر إشعارات المتصفح العادية
- تجربة أفضل للمستخدم أثناء استخدام الموقع

### 2. عندما يكون الموقع مغلق أو في الخلفية
- تظهر إشعارات المتصفح العادية
- يمكن للمستخدم النقر على الإشعار للعودة للموقع

### 3. لا توجد إشعارات مكررة
- النظام يتأكد من عدم إظهار نوعين من الإشعارات في نفس الوقت

## الملفات المُحدثة

### 1. `public/firebase-messaging-sw.js`
- **التحديث الرئيسي**: فحص حالة رؤية الصفحة قبل إظهار إشعار المتصفح
- **المنطق الجديد**: إذا كان أي client مرئي، لا تُظهر إشعار المتصفح
- **النتيجة**: إشعارات المتصفح تظهر فقط عندما يكون الموقع مغلق أو في الخلفية

```javascript
// فحص الـ clients المرئية
if (client.visibilityState === 'visible') {
  hasVisibleClient = true;
}

// إظهار إشعار المتصفح فقط إذا لم يكن هناك client مرئي
if (!hasVisibleClient || !hasAnyClient) {
  return self.registration.showNotification(notificationTitle, notificationOptions);
}
```

### 2. `components/notifications/notification-provider.tsx`
- **إضافة مراقبة رؤية الصفحة**: مراقبة `document.visibilityState`
- **تحسين معالج الرسائل**: إظهار Toast فقط عندما تكون الصفحة مرئية
- **مدة أطول للـ Toast**: 6 ثوانٍ بدلاً من 5 لرؤية أفضل

### 3. `hooks/use-firebase.ts`
- **تبسيط المنطق**: إزالة الفحص المتكرر لرؤية الصفحة
- **الاعتماد على onMessageListener**: الذي يفحص الرؤية داخلياً

### 4. `lib/firebase.ts`
- **تحسين onMessageListener**: فحص `document.visibilityState` قبل إرجاع الرسالة
- **منع الإشعارات المكررة**: تجاهل رسائل المقدمة عندما تكون الصفحة غير مرئية

## مكونات الاختبار

### 1. `notification-behavior-tester.tsx` (جديد)
- اختبار سلوك الإشعارات الجديد
- مقارنة بين Toast وإشعارات المتصفح
- فحص حالة رؤية الصفحة

### 2. تحديثات على `notification-tester.tsx`
- إضافة اختبارات محلية للـ Toast
- اختبار إشعارات المتصفح
- شرح آلية العمل الجديدة

## كيفية الاختبار

1. **اختبار Toast داخل الموقع**:
   - اذهب إلى صفحة الإشعارات
   - استخدم زر "اختبار Toast محلي"
   - يجب أن يظهر إشعار Toast داخل الموقع

2. **اختبار إشعار المتصفح**:
   - استخدم زر "اختبار إشعار المتصفح"
   - يجب أن يظهر إشعار المتصفح حتى لو كان الموقع مفتوح

3. **اختبار السلوك التلقائي**:
   - أرسل إشعار حقيقي من الـ backend
   - اختبر النتيجة عندما يكون الموقع مفتوح (يجب أن يظهر Toast)
   - اختبر النتيجة عندما يكون الموقع مغلق (يجب أن يظهر إشعار المتصفح)

## الفوائد

1. **تجربة مستخدم أفضل**: لا توجد إشعارات مزعجة عندما يكون المستخدم يستخدم الموقع
2. **إشعارات أوضح**: Toast داخل الموقع أوضح وأكثر تفاعلية
3. **لا توجد إشعارات مكررة**: النظام ذكي ويعرف متى يُظهر أي نوع من الإشعارات
4. **حفظ البطارية**: تقليل إشعارات المتصفح غير الضرورية

## إعدادات التطوير

في وضع التطوير، سيظهر toast تأكيدي عند تهيئة نظام الإشعارات:
```
"نظام الإشعارات جاهز - ستظهر الإشعارات كـ toast داخل الموقع عند فتحه"
```

## ملاحظات مهمة

- تأكد من تفعيل صلاحية الإشعارات في المتصفح
- النظام يعمل فقط مع HTTPS أو localhost
- قد تحتاج إلى إعادة تسجيل Service Worker في بعض الحالات
